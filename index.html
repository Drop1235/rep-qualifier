<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ä»£è¡¨æ±ºå®šæˆ¦</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase (Realtime Database) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <meta name="description" content="8äººã‹ã‚‰4äººã®ä»£è¡¨ã‚’æ±ºã‚ã‚‹ãƒ¯ãƒ³ãƒãƒƒãƒæ–¹å¼ï¼ˆ4è©¦åˆï¼‰ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆã€‚å‹è€…ã¨ã‚¹ã‚³ã‚¢ã‚’å…¥åŠ›ã—ã¦å³æ ã«ä»£è¡¨ã‚’è¡¨ç¤ºã€‚ãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•ä¿å­˜/å¾©å…ƒã€‚" />
  <style>
    /* å°åˆ·ã‚„ç´°ã‹ã„æ‹¡å¼µã¯åˆ¥é€”ã€‚ã“ã“ã§ã¯æœ€å°é™ã®è£œåŠ©ã®ã¿ */
    .modal-open { overflow: hidden; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <header class="max-w-6xl mx-auto px-4 sm:px-6 py-6 flex flex-col gap-4">
    <div class="flex items-center justify-between gap-4 flex-wrap">
      <h1 class="text-2xl sm:text-3xl font-bold">ä»£è¡¨æ±ºå®šæˆ¦</h1>
      <div class="flex gap-2 flex-wrap items-center">
        <span id="liveStatus" class="hidden text-sm text-slate-500"></span>
        <span id="viewOnlyBadge" class="hidden text-xs px-2 py-1 rounded border border-slate-300 bg-slate-100 text-slate-600">é–²è¦§ãƒ¢ãƒ¼ãƒ‰</span>
        <button id="shareBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg px-4 py-2 text-sm sm:text-base">å…±æœ‰ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼</button>
        <button id="resetBtn" class="bg-slate-700 hover:bg-slate-800 text-white rounded-lg px-4 py-2 text-sm sm:text-base">ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
    </div>
    <!-- ä»£è¡¨è€…ä¸€è¦§ï¼ˆ4åæ±ºå®šæ™‚ã«è‡ªå‹•è¡¨ç¤ºï¼‰ -->
    <div id="summaryBar" class="hidden">
      <div class="rounded-2xl border border-yellow-300 bg-yellow-50/60 p-3 sm:p-4 shadow-sm">
        <div class="flex items-center gap-2 mb-2">
          <span class="text-xl">ğŸ†</span>
          <h2 class="font-semibold">ä»£è¡¨è€…ä¸€è¦§ï¼ˆ4åï¼‰</h2>
        </div>
        <div id="summaryList" class="grid grid-cols-2 sm:grid-cols-4 gap-2">
          <!-- ä»£è¡¨è€…ã‚«ãƒ¼ãƒ‰ã‚’JSã§æ³¨å…¥ -->
        </div>
      </div>
    </div>
  </header>

  <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æœ¬ä½“ï¼š4è©¦åˆã®ã‚«ãƒ¼ãƒ‰ã‚’ä¸¦ã¹ã‚‹ -->
  <main class="max-w-6xl mx-auto px-4 sm:px-6 pb-16">
    <div id="matchesContainer" class="grid gap-4 sm:gap-6">
      <!-- å„è©¦åˆã‚«ãƒ¼ãƒ‰ã¯JSã§ç”Ÿæˆï¼ˆã‚¹ãƒãƒ›ï¼šç¸¦ä¸¦ã³ã€åºƒã„ç”»é¢ï¼šä¸Šä¸‹é–“éš”ï¼‰ -->
    </div>
  </main>

  <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆå…±é€šã€å†…å®¹ã¯JSã§å·®ã—æ›¿ãˆï¼‰ -->
  <div id="modalBackdrop" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50" aria-hidden="true">
    <div id="modalCard" class="w-[min(92vw,28rem)] rounded-2xl border bg-white shadow-lg p-4 sm:p-6" role="dialog" aria-modal="true">
      <div class="flex items-start justify-between gap-3 mb-3">
        <h3 id="modalTitle" class="text-lg font-semibold">ç¬¬Xè©¦åˆï¼šå‹è€…ã¨ã‚¹ã‚³ã‚¢ã‚’å…¥åŠ›</h3>
        <button id="modalCloseBtn" class="text-slate-500 hover:text-slate-700" aria-label="é–‰ã˜ã‚‹">âœ•</button>
      </div>
      <div class="space-y-4">
        <!-- å‹è€…é¸æŠ -->
        <div>
          <div class="text-sm text-slate-700 mb-2">å‹è€…ã®é¸æŠï¼ˆæœªé¸æŠã§ã‚‚OKï¼‰</div>
          <div class="flex flex-col gap-2">
            <label class="inline-flex items-center gap-2">
              <input type="radio" name="winnerRadio" value="p1" class="w-4 h-4">
              <span id="modalP1Name" class="text-sm"></span>
            </label>
            <label class="inline-flex items-center gap-2">
              <input type="radio" name="winnerRadio" value="p2" class="w-4 h-4">
              <span id="modalP2Name" class="text-sm"></span>
            </label>
          </div>
        </div>
        <!-- ã‚¹ã‚³ã‚¢å…¥åŠ›ï¼ˆè‡ªç”±æ–‡å­—åˆ—ï¼‰ -->
        <div>
          <div class="text-sm text-slate-700 mb-2">ã‚¹ã‚³ã‚¢ï¼ˆä¾‹ï¼š6-3ã€W/Oã€Ret ãªã©ã€‚æœªå…¥åŠ›å¯ï¼‰</div>
          <input id="modalScore" type="text" class="w-full rounded-lg border px-3 py-2 text-base" placeholder="ä¾‹ï¼š6-3">
        </div>
      </div>
      <div class="mt-6 flex justify-end gap-2">
        <button id="modalCancel" class="rounded-lg px-4 py-2 border text-slate-700 hover:bg-slate-50">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button id="modalOk" class="bg-blue-600 hover:bg-blue-700 text-white rounded-lg px-4 py-2">OK</button>
      </div>
    </div>
  </div>

  <script>
    // ==============================
    // çŠ¶æ…‹ç®¡ç† / ä¿å­˜ãƒ»å¾©å…ƒ
    // ==============================
    const STORAGE_KEY = 'rep_qualifier_v1';
    const SEARCH_PARAMS = new URLSearchParams(location.search);
    // é–²è¦§å°‚ç”¨ã®åˆ¤å®š: ?mode=view ã‚‚ã—ãã¯ å…±æœ‰ãƒãƒƒã‚·ãƒ¥(#s=...)ã§é–‹ã„ãŸå ´åˆã¯å¸¸ã«é–²è¦§å°‚ç”¨
    const VIEW_ONLY = (SEARCH_PARAMS.get('mode') === 'view') || (location.hash && location.hash.startsWith('#s='));
    const ROOM_PARAM = (SEARCH_PARAMS.get('room') || '').trim();
    // Firebase è¨­å®šï¼ˆã‚ãªãŸã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚­ãƒ¼ã«å·®ã—æ›¿ãˆã¦ãã ã•ã„ï¼‰
    const FIREBASE_CONFIG = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "",
      appId: "",
    };

    // players: 8å
    // matches: 4è©¦åˆ { p1Index, p2Index, winner: 'p1'|'p2'|null, score: '' }
    let state = {
      players: Array(8).fill(''),
      matches: [
        { p1Index: 0, p2Index: 1, winner: null, score: '' },
        { p1Index: 2, p2Index: 3, winner: null, score: '' },
        { p1Index: 4, p2Index: 5, winner: null, score: '' },
        { p1Index: 6, p2Index: 7, winner: null, score: '' },
      ],
    };

    function saveState() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        console.warn('localStorage ã«ä¿å­˜ã§ãã¾ã›ã‚“ã§ã—ãŸ', e);
      }
    }

    // å…±æœ‰URLï¼ˆãƒãƒƒã‚·ãƒ¥ï¼‰ã¸ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰/ãƒ‡ã‚³ãƒ¼ãƒ‰
    function encodeShareHash() {
      try {
        const data = {
          players: state.players,
          matches: state.matches.map(m => ({ w: m.winner, s: m.score })),
        };
        const json = JSON.stringify(data);
        const b64 = btoa(unescape(encodeURIComponent(json)));
        return `#s=${b64}`;
      } catch (e) {
        console.warn('å…±æœ‰ãƒªãƒ³ã‚¯ã®ç”Ÿæˆã«å¤±æ•—', e);
        return '';
      }
    }

    function tryLoadFromHash() {
      const h = location.hash || '';
      const m = h.match(/^#s=(.+)$/);
      if (!m) return false;
      try {
        const json = decodeURIComponent(escape(atob(m[1])));
        const data = JSON.parse(json);
        if (Array.isArray(data?.players) && Array.isArray(data?.matches)) {
          state.players = [...Array(8)].map((_, i) => data.players[i] ?? '');
          state.matches = state.matches.map((mm, i) => {
            const dm = data.matches[i] || {};
            return {
              p1Index: mm.p1Index,
              p2Index: mm.p2Index,
              winner: (dm.w === 'p1' || dm.w === 'p2') ? dm.w : null,
              score: typeof dm.s === 'string' ? dm.s : '',
            };
          });
          return true;
        }
      } catch (e) {
        console.warn('å…±æœ‰ãƒªãƒ³ã‚¯ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—', e);
      }
      return false;
    }

    // ç¾åœ¨ã®çŠ¶æ…‹ã§URLãƒãƒƒã‚·ãƒ¥ã‚’ç½®ãæ›ãˆï¼ˆå±¥æ­´ã¯å¢—ã‚„ã•ãªã„ï¼‰
    function updateShareHash() {
      const newHash = encodeShareHash();
      const newUrl = location.pathname + newHash;
      try {
        history.replaceState(null, '', newUrl);
      } catch {}
    }

    // ==============================
    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å…±æœ‰ï¼ˆFirebase Realtime Databaseï¼‰
    // ==============================
    let fb = { app: null, db: null, ref: null, roomId: null, applying: false, lastSentJson: '', debounceId: null };

    function initFirebaseOnce() {
      if (fb.app) return;
      if (!FIREBASE_CONFIG || !FIREBASE_CONFIG.apiKey || FIREBASE_CONFIG.apiKey === 'YOUR_API_KEY') {
        console.warn('Firebase è¨­å®šãŒæœªå…¥åŠ›ã§ã™ã€‚ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å…±æœ‰ã‚’ä½¿ã†ã«ã¯ config ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
        return;
      }
      fb.app = firebase.initializeApp(FIREBASE_CONFIG);
      fb.db = firebase.database();
    }

    function connectLive(roomId) {
      initFirebaseOnce();
      if (!fb.db) {
        alert('Firebase è¨­å®šãŒæœªå…¥åŠ›ã®ãŸã‚æ¥ç¶šã§ãã¾ã›ã‚“ã€‚');
        return;
      }
      disconnectLive();
      fb.roomId = roomId.trim();
      if (!fb.roomId) return;
      fb.ref = fb.db.ref(`/rooms/${fb.roomId}`);
      // å—ä¿¡
      fb.ref.on('value', (snap) => {
        const val = snap.val();
        if (!val) return;
        const json = JSON.stringify(val);
        // è‡ªåˆ†ãŒç›´å‰ã«é€ã£ãŸã‚‚ã®ã¯ç„¡è¦–
        if (json === fb.lastSentJson) return;
        fb.applying = true;
        try {
          // åæ˜ 
          if (Array.isArray(val.players) && Array.isArray(val.matches)) {
            state.players = [...Array(8)].map((_, i) => val.players[i] ?? '');
            state.matches = state.matches.map((mm, i) => {
              const dm = val.matches[i] || {};
              return {
                p1Index: mm.p1Index,
                p2Index: mm.p2Index,
                winner:
                  dm.w === 'p1' ? dm.w : dm.w === 'p2' ? dm.w : null,
                score: typeof dm.s === 'string' ? dm.s : '',
              };
            });
            saveState();
            // é–²è¦§ãƒ¢ãƒ¼ãƒ‰UIèª¿æ•´ï¼ˆãƒãƒƒã‚¸è¡¨ç¤ºãƒ»å…±æœ‰/ãƒªã‚»ãƒƒãƒˆéè¡¨ç¤ºï¼‰
            if (VIEW_ONLY) {
              const badge = document.getElementById('viewOnlyBadge');
              if (badge) badge.classList.remove('hidden');
              const shareBtn = document.getElementById('shareBtn');
              if (shareBtn) shareBtn.classList.add('hidden');
              const resetBtn = document.getElementById('resetBtn');
              if (resetBtn) resetBtn.classList.add('hidden');
            }
            // é–²è¦§ãƒ¢ãƒ¼ãƒ‰ã§ã¯URLãƒãƒƒã‚·ãƒ¥ã‚’å¤‰æ›´ã—ãªã„ï¼ˆä¸å¤‰ãƒªãƒ³ã‚¯ã®ãŸã‚ï¼‰
            if (!VIEW_ONLY) updateShareHash();
            render();
          }
        } finally {
          fb.applying = false;
        }
      });
      // URLã®roomãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚Œã°è‡ªå‹•æ¥ç¶šï¼ˆé–²è¦§è€…/ç·¨é›†è€…ã¨ã‚‚ã«å…¥åŠ›ä¸è¦ï¼‰
      if (ROOM_PARAM) {
        connectLive(ROOM_PARAM);
      }
      const ls = document.getElementById('liveStatus');
      if (ls) { ls.textContent = `æ¥ç¶šä¸­: ${fb.roomId}`; ls.classList.remove('hidden'); }
    }

    function disconnectLive() {
      if (fb.ref) {
        fb.ref.off();
        fb.ref = null;
      }
      fb.roomId = null;
      const ls = document.getElementById('liveStatus');
      if (ls) { ls.textContent = ''; ls.classList.add('hidden'); }
    }

    function pushLiveDebounced() {
      if (VIEW_ONLY) return; // é–²è¦§ãƒ¢ãƒ¼ãƒ‰ã¯é€ä¿¡ã—ãªã„
      if (!fb.db || !fb.ref || fb.applying) return; // æœªæ¥ç¶š or åæ˜ ä¸­ã¯é€ã‚‰ãªã„
      clearTimeout(fb.debounceId);
      fb.debounceId = setTimeout(() => {
        const payload = {
          players: state.players,
          matches: state.matches.map(m => ({ w: m.winner, s: m.score })),
          ts: Date.now(),
        };
        fb.lastSentJson = JSON.stringify(payload);
        fb.ref.set(payload).catch((e) => console.warn('é€ä¿¡å¤±æ•—', e));
      }, 200);
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
          const parsed = JSON.parse(raw);
          // è»½ã„ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
          if (Array.isArray(parsed?.players) && Array.isArray(parsed?.matches)) {
            state.players = [...Array(8)].map((_, i) => parsed.players[i] ?? '');
            state.matches = state.matches.map((m, i) => {
              const pm = parsed.matches[i] || {};
              return {
                p1Index: m.p1Index,
                p2Index: m.p2Index,
                winner: (pm.winner === 'p1' || pm.winner === 'p2') ? pm.winner : null,
                score: typeof pm.score === 'string' ? pm.score : '',
              };
            });
          }
        }
      } catch (e) {
        console.warn('localStorage ã‹ã‚‰ã®å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ', e);
      }
    }

    // ==============================
    // ã‚¹ã‚³ã‚¢è¡¨ç¤ºç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼
    // ==============================
    // "6-3" / "6 â€“ 3" / "6:3" ãªã©ã®å˜ç´”ãª2å€¤ã‚’è§£æï¼ˆå¤±æ•—æ™‚ã¯ nullï¼‰
    function parseScore(raw) {
      if (!raw) return null;
      const s = String(raw).trim();
      // è¨±å®¹: æ•°å­— [åŒºåˆ‡ã‚Š: -ã€â€“ã€:ã€/ã€ç©ºç™½] æ•°å­—
      const m = s.match(/^(\d+)\s*[\-â€“:\/\s]\s*(\d+)$/);
      if (!m) return null;
      return { p1: Number(m[1]), p2: Number(m[2]) };
    }

    // ç¸¦ä¸¦ã³ã®å¤§ãã‚ã‚¹ã‚³ã‚¢ã‚«ãƒ¼ãƒ‰ or ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆå°ã•ãªãƒãƒƒã‚¸ï¼‰
    function scoreHtml(match, p1Name, p2Name) {
      const s = parseScore(match.score || '');
      if (!match.score) return '';
      if (!s) {
        // ä»»æ„æ–‡å­—åˆ—ï¼ˆW/O ç­‰ï¼‰ã¯å°ã•ãªãƒãƒƒã‚¸ã¨ã—ã¦è¡¨ç¤ºï¼ˆå³å´æ å†…ç”¨ã®ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰
        return `<span class="inline-block text-[12px] text-slate-600 bg-slate-100 rounded px-2 py-0.5 border">${escapeHtml(match.score)}</span>`;
      }
      // æ•°å€¤ã‚¹ã‚³ã‚¢ã¯ã€Œp1 - p2ã€ã®ã‚·ãƒ³ãƒ—ãƒ«è¡¨è¨˜
      const txt = `${s.p1} - ${s.p2}`;
      return `<span class="inline-block text-[12px] text-slate-700 bg-slate-100 rounded px-2 py-0.5 border">${txt}</span>`;
    }

    // ==============================
    // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    // ==============================
    const matchesContainer = document.getElementById('matchesContainer');
    const summaryBar = document.getElementById('summaryBar');
    const summaryList = document.getElementById('summaryList');

    function render() {
      // 4è©¦åˆã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
      matchesContainer.innerHTML = state.matches.map((match, idx) => {
        const p1 = state.players[match.p1Index] || '';
        const p2 = state.players[match.p2Index] || '';
        const winnerName = match.winner === 'p1' ? p1 : match.winner === 'p2' ? p2 : '';
        const decided = !!winnerName;
        const score = match.score || '';

        return `
          <section class="rounded-2xl border bg-white shadow-sm p-4 sm:p-6">
            <div class="text-sm text-slate-500 mb-3">ç¬¬${idx + 1}è©¦åˆ</div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-stretch">
              <!-- å·¦ï¼šé¸æ‰‹åå…¥åŠ› 2æ  -->
              <div class="flex flex-col gap-3">
                <input data-role="player" data-index="${match.p1Index}" type="text" class="rounded-lg border px-3 py-2 text-lg" placeholder="é¸æ‰‹åã‚’å…¥åŠ›" value="${escapeHtml(p1)}" />
                <input data-role="player" data-index="${match.p2Index}" type="text" class="rounded-lg border px-3 py-2 text-lg" placeholder="é¸æ‰‹åã‚’å…¥åŠ›" value="${escapeHtml(p2)}" />
              </div>

              <!-- ä¸­å¤®ï¼šæ±ºå®šãƒœã‚¿ãƒ³ï¼ˆã‚¹ã‚³ã‚¢ã¯å³æ ã«è¡¨ç¤ºï¼‰ -->
              <div class="flex items-center justify-center min-h-[3.5rem]">
                ${VIEW_ONLY ? '' : `<button data-role="openModal" data-match="${idx}" class="bg-blue-600 hover:bg-blue-700 text-white rounded-lg px-4 py-2">å‹è€…/ã‚¹ã‚³ã‚¢ã‚’å…¥åŠ›</button>`}
              </div>

              <!-- å³ï¼šä»£è¡¨æ  -->
              <div class="rounded-2xl border ${decided ? 'border-yellow-400 bg-yellow-50/60' : 'border-slate-200'} p-4 flex items-center justify-between">
                <div class="flex flex-col gap-1">
                  <div class="text-xs text-slate-500 mb-1">ä»£è¡¨æ </div>
                  <div class="text-lg font-semibold min-h-[1.5rem]">${winnerName ? escapeHtml(winnerName) : '<span class=\"text-slate-400\">æœªæ±ºå®š</span>'}</div>
                  <div>${scoreHtml(match, p1, p2)}</div>
                </div>
                <div class="text-2xl">${decided ? 'ğŸ‘‘' : ' '}</div>
              </div>
            </div>
          </section>
        `;
      }).join('');

      // å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆ/ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä»˜ä¸
      matchesContainer.querySelectorAll('input[data-role="player"]').forEach((input) => {
        // å…¥åŠ›ä¸­ã¯çŠ¶æ…‹ä¿å­˜ï¼‹ãƒãƒƒã‚·ãƒ¥æ›´æ–°ã®ã¿ï¼ˆå†æç”»ã—ãªã„ï¼‰â†’ ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒé£›ã¶ã®ã‚’é˜²æ­¢
        input.addEventListener('input', (e) => {
          if (VIEW_ONLY) return; // é–²è¦§ãƒ¢ãƒ¼ãƒ‰ã§ã¯å…¥åŠ›ã‚’ç„¡è¦–
          const idx = Number(e.target.getAttribute('data-index'));
          state.players[idx] = e.target.value;
          saveState();
          // é–²è¦§ãƒ¢ãƒ¼ãƒ‰ã§ã¯URLãƒãƒƒã‚·ãƒ¥ã‚’æ›´æ–°ã—ãªã„ï¼ˆä¸å¤‰ãƒªãƒ³ã‚¯ã®ãŸã‚ï¼‰
          if (!VIEW_ONLY) updateShareHash();
          pushLiveDebounced();
        });
        // å…¥åŠ›çµ‚äº†æ™‚ã«å†æç”»ã—ã¦å³å´ã®ä»£è¡¨åãªã©ã‚’åŒæœŸ
        input.addEventListener('change', () => { if (!VIEW_ONLY) render(); });
        input.addEventListener('blur', () => { if (!VIEW_ONLY) render(); });
        // é–²è¦§ãƒ¢ãƒ¼ãƒ‰ã§ã¯è¦‹ãŸç›®ä¸Šã‚‚ç„¡åŠ¹åŒ–
        if (VIEW_ONLY) {
          input.setAttribute('disabled', 'true');
          input.classList.add('bg-slate-100', 'cursor-not-allowed');
        }
      });

      matchesContainer.querySelectorAll('button[data-role="openModal"]').forEach((btn) => {
        btn.addEventListener('click', () => {
          if (VIEW_ONLY) return; // é–²è¦§ãƒ¢ãƒ¼ãƒ‰ã§ã¯ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã‹ãªã„
          const matchIndex = Number(btn.getAttribute('data-match'));
          openModal(matchIndex);
        });
        if (VIEW_ONLY) {
          btn.setAttribute('disabled', 'true');
          btn.setAttribute('aria-disabled', 'true');
          btn.setAttribute('tabindex', '-1');
          btn.classList.add('opacity-50', 'cursor-not-allowed');
        }
      });

      // ä»£è¡¨è€…ä¸€è¦§ã®è¡¨ç¤ºæ›´æ–°
      renderSummary();
    }

    function renderSummary() {
      const decided = state.matches
        .map((m) => ({
          winner:
            m.winner === 'p1' ? state.players[m.p1Index] :
            m.winner === 'p2' ? state.players[m.p2Index] : '',
        }))
        .filter((x) => x.winner && x.winner.trim() !== '');

      if (decided.length === 4) {
        summaryBar.classList.remove('hidden');
        summaryList.innerHTML = decided.map((x) => `
          <div class="flex items-center gap-2 rounded-xl border border-yellow-300 bg-white/70 px-3 py-2">
            <span class="text-lg">ğŸ†</span>
            <span class="font-semibold">${escapeHtml(x.winner)}</span>
          </div>
        `).join('');
      } else {
        summaryBar.classList.add('hidden');
        summaryList.innerHTML = '';
      }
    }

    // ==============================
    // ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡
    // ==============================
    const modalBackdrop = document.getElementById('modalBackdrop');
    const modalTitle = document.getElementById('modalTitle');
    const modalP1Name = document.getElementById('modalP1Name');
    const modalP2Name = document.getElementById('modalP2Name');
    const modalScore = document.getElementById('modalScore');
    const modalCloseBtn = document.getElementById('modalCloseBtn');
    const modalCancel = document.getElementById('modalCancel');
    const modalOk = document.getElementById('modalOk');

    let currentMatchIndex = null;

    function openModal(matchIndex) {
      currentMatchIndex = matchIndex;
      const m = state.matches[matchIndex];
      const p1 = state.players[m.p1Index] || '';
      const p2 = state.players[m.p2Index] || '';

      modalTitle.textContent = `ç¬¬${matchIndex + 1}è©¦åˆï¼šå‹è€…ã¨ã‚¹ã‚³ã‚¢ã‚’å…¥åŠ›`;
      modalP1Name.textContent = p1 || 'ï¼ˆæœªå…¥åŠ›ï¼‰';
      modalP2Name.textContent = p2 || 'ï¼ˆæœªå…¥åŠ›ï¼‰';
      modalScore.value = m.score || '';

      // ãƒ©ã‚¸ã‚ªåˆæœŸåŒ–
      document.querySelectorAll('input[name="winnerRadio"]').forEach((r) => {
        r.checked = false;
      });
      if (m.winner === 'p1') document.querySelector('input[name="winnerRadio"][value="p1"]').checked = true;
      if (m.winner === 'p2') document.querySelector('input[name="winnerRadio"][value="p2"]').checked = true;

      modalBackdrop.classList.remove('hidden');
      modalBackdrop.classList.add('flex');
      document.body.classList.add('modal-open');

      // Escã§é–‰ã˜ã‚‹
      document.addEventListener('keydown', onEscClose);
    }

    function closeModal() {
      modalBackdrop.classList.add('hidden');
      modalBackdrop.classList.remove('flex');
      document.body.classList.remove('modal-open');
      document.removeEventListener('keydown', onEscClose);
      currentMatchIndex = null;
    }

    function onEscClose(e) {
      if (e.key === 'Escape') closeModal();
    }

    // ãƒãƒƒã‚¯ãƒ‰ãƒ­ãƒƒãƒ—ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹ï¼ˆã‚«ãƒ¼ãƒ‰å†…ã‚¯ãƒªãƒƒã‚¯ã¯é™¤å¤–ï¼‰
    modalBackdrop.addEventListener('click', (e) => {
      if (e.target === modalBackdrop) closeModal();
    });
    modalCloseBtn.addEventListener('click', closeModal);
    modalCancel.addEventListener('click', closeModal);

    modalOk.addEventListener('click', () => {
      if (VIEW_ONLY) return; // é–²è¦§ãƒ¢ãƒ¼ãƒ‰ã§ã¯ä¿å­˜ä¸å¯
      if (currentMatchIndex == null) return;
      const m = state.matches[currentMatchIndex];
      const selected = document.querySelector('input[name="winnerRadio"]:checked');
      const newScore = modalScore.value || '';

      // é‡è¦ï¼šãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãªã—ã€‚æœªé¸æŠãƒ»æœªå…¥åŠ›OKã€‚
      if (selected) {
        m.winner = selected.value; // 'p1' ã¾ãŸã¯ 'p2'
      }
      m.score = newScore; // ç©ºæ–‡å­—OK

      saveState();
      updateShareHash();
      pushLiveDebounced();
      render();
      closeModal();
    });

    // ==============================
    // ãƒ˜ãƒƒãƒ€ãƒ¼ãƒœã‚¿ãƒ³
    // ==============================
    // å…±æœ‰ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸
    document.getElementById('shareBtn').addEventListener('click', async () => {
      // æ¥ç¶šä¸­ã¯ä¸å¤‰ã®é–²è¦§ãƒªãƒ³ã‚¯ã‚’å„ªå…ˆã—ã¦ã‚³ãƒ”ãƒ¼ï¼ˆ?mode=view&room=IDï¼‰ã€‚
      // æœªæ¥ç¶šãªã‚‰å¾“æ¥ã®çŠ¶æ…‹ä»˜ããƒãƒƒã‚·ãƒ¥URLã‚’ã‚³ãƒ”ãƒ¼ã€‚
      const url = (fb.roomId)
        ? `${location.origin}${location.pathname}?mode=view&room=${encodeURIComponent(fb.roomId)}`
        : location.origin + location.pathname + encodeShareHash();
      try {
        await navigator.clipboard.writeText(url);
        alert('å…±æœ‰ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ\n' + url);
      } catch {
        // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ä¸å¯ç’°å¢ƒå‘ã‘ã«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
        prompt('ã“ã®URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„', url);
      }
    });

    document.getElementById('resetBtn').addEventListener('click', () => {
      if (VIEW_ONLY) return; // é–²è¦§ãƒ¢ãƒ¼ãƒ‰ã§ã¯ãƒªã‚»ãƒƒãƒˆä¸å¯
      // å®Œå…¨åˆæœŸåŒ– + localStorage ã‚¯ãƒªã‚¢
      state.players = Array(8).fill('');
      state.matches = [
        { p1Index: 0, p2Index: 1, winner: null, score: '' },
        { p1Index: 2, p2Index: 3, winner: null, score: '' },
        { p1Index: 4, p2Index: 5, winner: null, score: '' },
        { p1Index: 6, p2Index: 7, winner: null, score: '' },
      ];
      try { localStorage.removeItem(STORAGE_KEY); } catch {}
      updateShareHash();
      pushLiveDebounced();
      render();
    });

    // æ‰‹å‹•æ¥ç¶šUIã¯æ’¤å»ã€‚URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ã¿ã§è‡ªå‹•æ¥ç¶šã—ã¾ã™ã€‚

    // ==============================
    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    // ==============================
    function escapeHtml(str) {
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    // ==============================
    // åˆæœŸåŒ–
    // ==============================
    // å…±æœ‰ãƒªãƒ³ã‚¯ãŒã‚ã‚Œã°å„ªå…ˆã—ã¦èª­ã¿è¾¼ã¿ã€ãªã‘ã‚Œã° localStorage
    if (!tryLoadFromHash()) {
      loadState();
    }

    // é–²è¦§ãƒ¢ãƒ¼ãƒ‰ã®åˆæœŸUIèª¿æ•´ï¼ˆæœ€åˆã®æç”»å‰ã«åæ˜ ï¼‰
    if (VIEW_ONLY) {
      const badge = document.getElementById('viewOnlyBadge');
      if (badge) badge.classList.remove('hidden');
      const shareBtn = document.getElementById('shareBtn');
      if (shareBtn) shareBtn.classList.add('hidden');
      const resetBtn = document.getElementById('resetBtn');
      if (resetBtn) resetBtn.classList.add('hidden');
    }
    render();
  </script>
</body>
</html>
