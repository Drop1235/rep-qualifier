<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>テニス大会｜8人中4人が代表トーナメント</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="description" content="8人から4人の代表を決めるワンマッチ方式（4試合）トーナメント。勝者とスコアを入力して右枠に代表を表示。データは自動保存/復元。" />
  <style>
    /* 印刷や細かい拡張は別途。ここでは最小限の補助のみ */
    .modal-open { overflow: hidden; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <!-- ヘッダー -->
  <header class="max-w-6xl mx-auto px-4 sm:px-6 py-6 flex flex-col gap-4">
    <div class="flex items-center justify-between gap-4 flex-wrap">
      <h1 class="text-2xl sm:text-3xl font-bold">8人中4人が代表トーナメント</h1>
      <div class="flex gap-2">
        <button id="demoBtn" class="bg-blue-600 hover:bg-blue-700 text-white rounded-lg px-4 py-2 text-sm sm:text-base">デモ名を入れる</button>
        <button id="resetBtn" class="bg-slate-700 hover:bg-slate-800 text-white rounded-lg px-4 py-2 text-sm sm:text-base">リセット</button>
      </div>
    </div>
    <!-- 代表者一覧（4名決定時に自動表示） -->
    <div id="summaryBar" class="hidden">
      <div class="rounded-2xl border border-yellow-300 bg-yellow-50/60 p-3 sm:p-4 shadow-sm">
        <div class="flex items-center gap-2 mb-2">
          <span class="text-xl">🏆</span>
          <h2 class="font-semibold">代表者一覧（4名）</h2>
        </div>
        <div id="summaryList" class="grid grid-cols-2 sm:grid-cols-4 gap-2">
          <!-- 代表者カードをJSで注入 -->
        </div>
      </div>
    </div>
  </header>

  <!-- コンテンツ本体：4試合のカードを並べる -->
  <main class="max-w-6xl mx-auto px-4 sm:px-6 pb-16">
    <div id="matchesContainer" class="grid gap-4 sm:gap-6">
      <!-- 各試合カードはJSで生成（スマホ：縦並び、広い画面：上下間隔） -->
    </div>
    <p class="text-xs text-slate-500 mt-4">補足：勝者未選択・スコア未入力でもOKで閉じられます（バリデーションなし）。</p>
  </main>

  <!-- モーダル（共通、内容はJSで差し替え） -->
  <div id="modalBackdrop" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50" aria-hidden="true">
    <div id="modalCard" class="w-[min(92vw,28rem)] rounded-2xl border bg-white shadow-lg p-4 sm:p-6" role="dialog" aria-modal="true">
      <div class="flex items-start justify-between gap-3 mb-3">
        <h3 id="modalTitle" class="text-lg font-semibold">第X試合：勝者とスコアを入力</h3>
        <button id="modalCloseBtn" class="text-slate-500 hover:text-slate-700" aria-label="閉じる">✕</button>
      </div>
      <div class="space-y-4">
        <!-- 勝者選択 -->
        <div>
          <div class="text-sm text-slate-700 mb-2">勝者の選択（未選択でもOK）</div>
          <div class="flex flex-col gap-2">
            <label class="inline-flex items-center gap-2">
              <input type="radio" name="winnerRadio" value="p1" class="w-4 h-4">
              <span id="modalP1Name" class="text-sm"></span>
            </label>
            <label class="inline-flex items-center gap-2">
              <input type="radio" name="winnerRadio" value="p2" class="w-4 h-4">
              <span id="modalP2Name" class="text-sm"></span>
            </label>
          </div>
        </div>
        <!-- スコア入力（自由文字列） -->
        <div>
          <div class="text-sm text-slate-700 mb-2">スコア（例：6-3、W/O、Ret など。未入力可）</div>
          <input id="modalScore" type="text" class="w-full rounded-lg border px-3 py-2 text-base" placeholder="例：6-3">
        </div>
      </div>
      <div class="mt-6 flex justify-end gap-2">
        <button id="modalCancel" class="rounded-lg px-4 py-2 border text-slate-700 hover:bg-slate-50">キャンセル</button>
        <button id="modalOk" class="bg-blue-600 hover:bg-blue-700 text-white rounded-lg px-4 py-2">OK</button>
      </div>
    </div>
  </div>

  <script>
    // ==============================
    // 状態管理 / 保存・復元
    // ==============================
    const STORAGE_KEY = 'rep_qualifier_v1';

    // players: 8名
    // matches: 4試合 { p1Index, p2Index, winner: 'p1'|'p2'|null, score: '' }
    let state = {
      players: Array(8).fill(''),
      matches: [
        { p1Index: 0, p2Index: 1, winner: null, score: '' },
        { p1Index: 2, p2Index: 3, winner: null, score: '' },
        { p1Index: 4, p2Index: 5, winner: null, score: '' },
        { p1Index: 6, p2Index: 7, winner: null, score: '' },
      ],
    };

    function saveState() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        console.warn('localStorage に保存できませんでした', e);
      }
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
          const parsed = JSON.parse(raw);
          // 軽いフォールバック
          if (Array.isArray(parsed?.players) && Array.isArray(parsed?.matches)) {
            state.players = [...Array(8)].map((_, i) => parsed.players[i] ?? '');
            state.matches = state.matches.map((m, i) => {
              const pm = parsed.matches[i] || {};
              return {
                p1Index: m.p1Index,
                p2Index: m.p2Index,
                winner: (pm.winner === 'p1' || pm.winner === 'p2') ? pm.winner : null,
                score: typeof pm.score === 'string' ? pm.score : '',
              };
            });
          }
        }
      } catch (e) {
        console.warn('localStorage からの復元に失敗しました', e);
      }
    }

    // ==============================
    // スコア表示用ヘルパー
    // ==============================
    // "6-3" / "6 – 3" / "6:3" などの単純な2値を解析（失敗時は null）
    function parseScore(raw) {
      if (!raw) return null;
      const s = String(raw).trim();
      // 許容: 数字 [区切り: -、–、:、/、空白] 数字
      const m = s.match(/^(\d+)\s*[\-–:\/\s]\s*(\d+)$/);
      if (!m) return null;
      return { p1: Number(m[1]), p2: Number(m[2]) };
    }

    // 縦並びの大きめスコアカード or フォールバック（小さなバッジ）
    function scoreHtml(match, p1Name, p2Name) {
      const s = parseScore(match.score || '');
      if (!match.score) return '';
      if (!s) {
        // 任意文字列（W/O 等）は従来の小バッジでそのまま表示
        return `<span class="absolute -top-2 right-0 md:right-4 text-xs text-slate-600 bg-slate-100 rounded px-2 py-0.5 border">${escapeHtml(match.score)}</span>`;
      }
      const hi = s.p1 === s.p2 ? null : (s.p1 > s.p2 ? 'p1' : 'p2');
      const rowBase = 'flex items-center justify-between gap-3';
      const rowHi = 'rounded-lg bg-yellow-50/80 px-2 py-1 border border-yellow-200';
      const rowLo = 'px-1 py-1';
      return `
        <div class="absolute right-0 md:right-4 -top-1 md:top-1">
          <div class="rounded-xl border bg-white/95 backdrop-blur shadow px-3 py-2 min-w-[11rem]">
            <div class="${rowBase} ${hi === 'p1' ? rowHi : rowLo}">
              <span class="text-[11px] text-slate-600 max-w-[7rem] truncate">${escapeHtml(p1Name || '')}</span>
              <span class="text-2xl leading-none font-extrabold text-slate-800">${s.p1}</span>
            </div>
            <div class="h-px bg-slate-200 my-1"></div>
            <div class="${rowBase} ${hi === 'p2' ? rowHi : rowLo}">
              <span class="text-[11px] text-slate-600 max-w-[7rem] truncate">${escapeHtml(p2Name || '')}</span>
              <span class="text-2xl leading-none font-extrabold text-slate-800">${s.p2}</span>
            </div>
          </div>
        </div>
      `;
    }

    // ==============================
    // レンダリング
    // ==============================
    const matchesContainer = document.getElementById('matchesContainer');
    const summaryBar = document.getElementById('summaryBar');
    const summaryList = document.getElementById('summaryList');

    function render() {
      // 4試合カードを生成
      matchesContainer.innerHTML = state.matches.map((match, idx) => {
        const p1 = state.players[match.p1Index] || '';
        const p2 = state.players[match.p2Index] || '';
        const winnerName = match.winner === 'p1' ? p1 : match.winner === 'p2' ? p2 : '';
        const decided = !!winnerName;
        const score = match.score || '';

        return `
          <section class="rounded-2xl border bg-white shadow-sm p-4 sm:p-6">
            <div class="text-sm text-slate-500 mb-3">第${idx + 1}試合</div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-stretch">
              <!-- 左：選手名入力 2枠 -->
              <div class="flex flex-col gap-3">
                <input data-role="player" data-index="${match.p1Index}" type="text" class="rounded-lg border px-3 py-2 text-lg" placeholder="選手名を入力" value="${escapeHtml(p1)}" />
                <input data-role="player" data-index="${match.p2Index}" type="text" class="rounded-lg border px-3 py-2 text-lg" placeholder="選手名を入力" value="${escapeHtml(p2)}" />
              </div>

              <!-- 中央：決定ボタン＋スコア表示 -->
              <div class="relative flex items-center justify-center min-h-[3.5rem]">
                <button data-role="openModal" data-match="${idx}" class="bg-blue-600 hover:bg-blue-700 text-white rounded-lg px-4 py-2">勝者/スコアを入力</button>
                ${scoreHtml(match, p1, p2)}
              </div>

              <!-- 右：代表枠 -->
              <div class="rounded-2xl border ${decided ? 'border-yellow-400 bg-yellow-50/60' : 'border-slate-200'} p-4 flex items-center justify-between">
                <div>
                  <div class="text-xs text-slate-500 mb-1">代表枠</div>
                  <div class="text-lg font-semibold min-h-[1.5rem]">${winnerName ? escapeHtml(winnerName) : '<span class=\"text-slate-400\">未決定</span>'}</div>
                </div>
                <div class="text-2xl">${decided ? '👑' : ' '}</div>
              </div>
            </div>
          </section>
        `;
      }).join('');

      // 入力イベント/ボタンイベントを付与
      matchesContainer.querySelectorAll('input[data-role="player"]').forEach((input) => {
        input.addEventListener('input', (e) => {
          const idx = Number(e.target.getAttribute('data-index'));
          state.players[idx] = e.target.value;
          saveState();
          // 代表名が該当選手のときは表示更新のため再描画
          render();
        });
      });

      matchesContainer.querySelectorAll('button[data-role="openModal"]').forEach((btn) => {
        btn.addEventListener('click', () => {
          const matchIndex = Number(btn.getAttribute('data-match'));
          openModal(matchIndex);
        });
      });

      // 代表者一覧の表示更新
      renderSummary();
    }

    function renderSummary() {
      const decided = state.matches
        .map((m) => ({
          winner:
            m.winner === 'p1' ? state.players[m.p1Index] :
            m.winner === 'p2' ? state.players[m.p2Index] : '',
        }))
        .filter((x) => x.winner && x.winner.trim() !== '');

      if (decided.length === 4) {
        summaryBar.classList.remove('hidden');
        summaryList.innerHTML = decided.map((x) => `
          <div class="flex items-center gap-2 rounded-xl border border-yellow-300 bg-white/70 px-3 py-2">
            <span class="text-lg">🏆</span>
            <span class="font-semibold">${escapeHtml(x.winner)}</span>
          </div>
        `).join('');
      } else {
        summaryBar.classList.add('hidden');
        summaryList.innerHTML = '';
      }
    }

    // ==============================
    // モーダル制御
    // ==============================
    const modalBackdrop = document.getElementById('modalBackdrop');
    const modalTitle = document.getElementById('modalTitle');
    const modalP1Name = document.getElementById('modalP1Name');
    const modalP2Name = document.getElementById('modalP2Name');
    const modalScore = document.getElementById('modalScore');
    const modalCloseBtn = document.getElementById('modalCloseBtn');
    const modalCancel = document.getElementById('modalCancel');
    const modalOk = document.getElementById('modalOk');

    let currentMatchIndex = null;

    function openModal(matchIndex) {
      currentMatchIndex = matchIndex;
      const m = state.matches[matchIndex];
      const p1 = state.players[m.p1Index] || '';
      const p2 = state.players[m.p2Index] || '';

      modalTitle.textContent = `第${matchIndex + 1}試合：勝者とスコアを入力`;
      modalP1Name.textContent = p1 || '（未入力）';
      modalP2Name.textContent = p2 || '（未入力）';
      modalScore.value = m.score || '';

      // ラジオ初期化
      document.querySelectorAll('input[name="winnerRadio"]').forEach((r) => {
        r.checked = false;
      });
      if (m.winner === 'p1') document.querySelector('input[name="winnerRadio"][value="p1"]').checked = true;
      if (m.winner === 'p2') document.querySelector('input[name="winnerRadio"][value="p2"]').checked = true;

      modalBackdrop.classList.remove('hidden');
      modalBackdrop.classList.add('flex');
      document.body.classList.add('modal-open');

      // Escで閉じる
      document.addEventListener('keydown', onEscClose);
    }

    function closeModal() {
      modalBackdrop.classList.add('hidden');
      modalBackdrop.classList.remove('flex');
      document.body.classList.remove('modal-open');
      document.removeEventListener('keydown', onEscClose);
      currentMatchIndex = null;
    }

    function onEscClose(e) {
      if (e.key === 'Escape') closeModal();
    }

    // バックドロップクリックで閉じる（カード内クリックは除外）
    modalBackdrop.addEventListener('click', (e) => {
      if (e.target === modalBackdrop) closeModal();
    });
    modalCloseBtn.addEventListener('click', closeModal);
    modalCancel.addEventListener('click', closeModal);

    modalOk.addEventListener('click', () => {
      if (currentMatchIndex == null) return;
      const m = state.matches[currentMatchIndex];
      const selected = document.querySelector('input[name="winnerRadio"]:checked');
      const newScore = modalScore.value || '';

      // 重要：バリデーションなし。未選択・未入力OK。
      if (selected) {
        m.winner = selected.value; // 'p1' または 'p2'
      }
      m.score = newScore; // 空文字OK

      saveState();
      render();
      closeModal();
    });

    // ==============================
    // ヘッダーボタン
    // ==============================
    document.getElementById('demoBtn').addEventListener('click', () => {
      const demo = ['Aさん','Bさん','Cさん','Dさん','Eさん','Fさん','Gさん','Hさん'];
      state.players = demo.slice(0, 8);
      saveState();
      render();
    });

    document.getElementById('resetBtn').addEventListener('click', () => {
      // 完全初期化 + localStorage クリア
      state.players = Array(8).fill('');
      state.matches = [
        { p1Index: 0, p2Index: 1, winner: null, score: '' },
        { p1Index: 2, p2Index: 3, winner: null, score: '' },
        { p1Index: 4, p2Index: 5, winner: null, score: '' },
        { p1Index: 6, p2Index: 7, winner: null, score: '' },
      ];
      try { localStorage.removeItem(STORAGE_KEY); } catch {}
      render();
    });

    // ==============================
    // ユーティリティ
    // ==============================
    function escapeHtml(str) {
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    // ==============================
    // 初期化
    // ==============================
    loadState();
    render();
  </script>
</body>
</html>
